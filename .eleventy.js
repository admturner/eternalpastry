const { DateTime } = require('luxon');
const he = require('he');
const htmlmin = require("html-minifier");
const markdownIt = require('markdown-it');
const markdownItAnchor = require('markdown-it-anchor');
const markdownItAttrs = require('markdown-it-attrs');
const markdownItFootnote = require('markdown-it-footnote');
const pluginRss = require('@11ty/eleventy-plugin-rss');
const pluginSyntaxHighlight = require('@11ty/eleventy-plugin-syntaxhighlight');

const htmlminConfig = {
	caseSensitive: true,
	collapseBooleanAttributes: true,
	collapseWhitespace: true,
	decodeEntities: true,
	includeAutoGeneratedTags: false,
	preventAttributesEscaping: true,
	removeComments: true,
	removeEmptyAttributes: true,
	removeRedundantAttributes: true,
	sortAttributes: true,
	sortClassName: true,
	useShortDoctype: true,
};

const markdownItConfig = {
	html: true,
	breaks: true,
	linkify: true,
};

const markdownItAnchorConfig = {
	permalink: true,
	permalinkClass: 'bookmark',
	permalinkSymbol: '#',
};

const mdIt = markdownIt(markdownItConfig)
	.use(markdownItFootnote)
	.use(markdownItAttrs)
	.use(markdownItAnchor, markdownItAnchorConfig);

module.exports = (eleventyConfig) => {
	eleventyConfig.addPlugin(pluginRss);
	eleventyConfig.addPlugin(pluginSyntaxHighlight, {
		templateFormats: "md"
	});

	eleventyConfig.addFilter('htmlDate', (dateObj) => {
		return DateTime.fromJSDate(dateObj).toFormat('yyyy-LL-dd');
	});

	eleventyConfig.addFilter('readableDate', (dateObj) => {
		return DateTime.fromJSDate(dateObj).toFormat('LLLL d, yyyy');
	});

	eleventyConfig.addFilter('markdown', (string) => {
		return mdIt.renderInline(string);
	});

	eleventyConfig.addFilter('decodeHtmlEntities', (string) => {
		return he.decode(string);
	});

	eleventyConfig.addFilter('slice', (array, n) => {
		// Returns from the first to the nth item in an array.
		return array.slice(0, n);
	});

	eleventyConfig.addCollection("posts", (collection) => {
		// Could instead provide an array of globs, to catch everything.
		// return collection.getFilteredByGlob([
		// 	"src/blog/*.md",
		// 	"src/other/*.md",
		// 	"src/other/**/*.md", // would include subdirs as well
		// ]);
		return collection.getFilteredByGlob("src/blog/*.md")
			.sort((a, b) => b.date - a.date);
	});

	eleventyConfig.addCollection("recipes", (collection) => {
		return collection.getFilteredByGlob("src/recipes/*.md")
			.sort((a, b) => b.date - a.date);
	});

	eleventyConfig.setLibrary('md', mdIt);

	eleventyConfig.addPassthroughCopy('src/_images');

	eleventyConfig.addTransform("htmlmin", (content, outputPath) => {
		if ( outputPath.endsWith(".html") ) {
			let minified = htmlmin.minify(content, htmlminConfig);
			return minified;
		}
		return content;
	});

	return {
		markdownTemplateEngine: 'njk',
		htmlTemplateEngine: 'njk',
		dataTemplateEngine: 'njk',
		passthroughFileCopy: true,
		dir: {
			input: "src",
			includes: "_includes",
			data: "_data",
			output: "dist"
		},
	};
};
